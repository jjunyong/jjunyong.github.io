---
emoji: ðŸ§¢
<<<<<<< HEAD
title: 'ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì› ë‚´ë¶€êµ¬ì¡°'
date: '2024-03-05 11:00:00'
author: jjunyong
tags: network
categories: Linux DevOps
---

- ì „ì²´ì ì¸ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì› êµ¬ì¡°ëŠ” Serviceë¥¼ í†µí•´ podë¥¼ ë…¸ì¶œì‹œí‚¤ë˜, serviceëŠ” L4ì˜ì—­ê¹Œì§€ë§Œ ë‹´ë‹¹í•˜ê³ , 
L7ì˜ ì—­í• ì„ í•˜ëŠ” ingressë¥¼ Loadbalancer type serviceì™€ ì—°ê²°ì‹œì¼œì„œ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ” êµ¬ì¡°ì´ë‹¤. 

- ë©€í‹° ë…¸ë“œ í´ëŸ¬ìŠ¤í„°ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œí•˜ê¸° ìœ„í•´ì„œ Loadbalancerë¥¼ ê¼­ ì¨ì•¼ í•˜ëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤. ë¬¼ë¡  ê·¸ë ‡ê²Œ í•  ìˆ˜ë„ ìžˆì§€ë§Œ, 
íŠ¹ì • ì›Œì»¤ ë…¸ë“œë“¤ì— ingressgatewayë¥¼ ê³ ì •ìœ¼ë¡œ ë°•ì•„ë‘ê³ , nodePortë¡œ ì˜¤í”ˆí•œ ë‹¤ìŒ, ì•ž ë‹¨ì— ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ë‘ê³  í•´ë‹¹ nodeì˜ ip : portë¡œ ë¡œë“œë°¸ëŸ°ì‹±ë˜ë„ë¡ ì„¤ì •í•  ìˆ˜ë„ ìžˆë‹¤. 

- rolling update ë°°í¬
  - ëª¨ë‹ˆí„°ë§ : watch -n 0.1 ì˜µì…˜ ì‚¬ìš©ìœ¼ë¡œ ì‹¤ì‹œê°„ í™•ì¸ ê°€ëŠ¥
  ```bash
  watch -n 0.1 kubectl get po,rs,deploy -o wide
  ```
  - ë¡¤ë°±
  ```
  kubectl rollout undo <deploy name>
  # íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
  kubectl rollout undo <deploy name> --to-revision 2
  ```

### k8s ë„¤íŠ¸ì› ìš©ì–´
- NAT : ë‚´ë¶€ë§ì„ ìœ„í•œ ip ì£¼ì†Œë¡œ ë³€í™˜
- SNAT : íŒ¨í‚·ì´ ë‚´ë¶€ì—ì„œ ì™¸ë¶€ë¡œ ë‚˜ê°ˆ ë•Œ Source ipì£¼ì†Œë¥¼ ê³ ì •(public) ipë¡œ ë³€í™˜
- DNAT : íŒ¨í‚·ì´ ì™¸ë¶€ì—ì„œ ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¬ ë•Œ Destination ip ì£¼ì†Œë¥¼ ë‚´ë¶€ ipì£¼ì†Œë¡œ ë³€í™˜ ( ex. ë¡œë“œë°¸ëŸ°ì„œ )
- ip_forwarding (net.ipv4.ip_forward) : í•´ë‹¹ ê°’ì€ í˜„ìž¬ ë¦¬ëˆ…ìŠ¤ì„œë²„ê°€ ë¼ìš°íŒ…ì—­í• ì„ í•  ìˆ˜ ìžˆê²Œ í•  ê²ƒì¸ì§€ì— ëŒ€í•œ enable ì—¬ë¶€ë¥¼ ì •í•˜ëŠ” ê²ƒ. 
- rr(round robin) : ë¡œë“œë°¸ëŸ°ì„œì˜ ë™ìž‘ëª¨ë“œ ì¤‘ í•˜ë‚˜ 

### kube-proxy
- kube-proxyëŠ” k8s ë‚´ë¶€ ë„¤íŠ¸ì›ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ë©° ì»¤ë„ ë‚´ì˜ NetFilterë¥¼ í™œìš©í•œë‹¤.
- userspace, iptables, IPVSëª¨ë“œê°€ ìžˆë‹¤.


### ë„ì»¤ ë„¤íŠ¸ì›ì˜ êµ¬ì¡°
- ì»¨í…Œì´ë„ˆë§ˆë‹¤ Network namespaceë¥¼ ìƒì„±í•œë‹¤.
- Bridge network interfaceë¥¼ ìƒì„±í•œë‹¤.
- ê°€ìƒ cableì¸ veth pairë¥¼ ë§Œë“¤ì–´ì„œ ì»¨í…Œì´ë„ˆì˜ network interfaceì™€ bridgeì¸ docker0ë¥¼ ì—°ê²°í•œë‹¤.
- í•´ë‹¹ vethì— ipì£¼ì†Œë¥¼ í• ë‹¹í•œë‹¤. ( ê³§ ì»¨í…Œì´ë„ˆì˜ ipê°€ ëœë‹¤)
- prerouting chainì— ruleì„ ì¶”ê°€í•¨ìœ¼ë¡œì¨ iptableì— í¬íŠ¸ í¬ì›Œë”©ì„ ìœ„í•œ NAT table entry ìƒì„±í•œë‹¤.

-> ê·¸ë¦¬ê³  ì´ ëª¨ë“  ê³¼ì •ì€ 'bridge'ë¼ëŠ” binaryë¥¼ í†µí•´ì„œ ì¼ê´„ ì„¤ì •ëœë‹¤.

### CNI ( container network interface )
- ë„ì»¤ì—ì„œëŠ” Bridgeë¼ëŠ” binaryë¥¼ í†µí•´ ì´ë¥¼ ì„¤ì •í•˜ì§€ë§Œ, ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ìž„ì—ì„œëŠ” ë‹¤ë¥¸ binaryë¥¼ ì‚¬ìš©í•  ê²ƒì´ë‹¤. CNIëŠ” ëŸ°íƒ€ìž„ì˜ ì¢…ë¥˜ì™€ ìƒê´€ì—†ì´ ë„¤íŠ¸ì› í™˜ê²½ì„ êµ¬ì„±í•˜ê¸° ìœ„í•œ í‘œì¤€ì´ë©°, bridgeì™€ ê°™ì€ í”„ë¡œê·¸ëž¨ì€ CNI plugin ì˜ ì¢…ë¥˜ì´ë‹¤.  
- ì»¨í…Œì´ë„ˆ ìƒì„± ì‹œ ë°”ë¡œ ë„¤íŠ¸ì›ì— ì—°ê²°í•˜ëŠ” ìœ„ì™€ ê°™ì€ ìž‘ì—…ì„ í•´ì¤˜ì•¼ í•˜ê¸°ì— ì»¨í…Œì´ë„ˆ ìƒì„±ì„ ì±…ìž„ì§€ëŠ” kubeletê´€ë ¨ ì„¤ì •ì— ì–´ë–¤ CNI pluginì„ ì‚¬ìš©í•  ì§€ ì •ì˜ëœë‹¤. 
- CNIëŠ” IPAM ì—­í• ì„ í•˜ë©° podì™€ serviceê°€ ì–´ë–¤ ipëŒ€ì—­ì„ ì‚¬ìš©í•  ì§€ ì •ì±…ì„ ì„¤ì •í•  ìˆ˜ ìžˆë‹¤. 
#### Weavenet
- weave peerë¼ëŠ” agentê°€ dameonsetìœ¼ë¡œ ëª¨ë“  ë…¸ë“œì— ìƒì„±ë˜ë©° ì´ëŠ” podê°„ í†µì‹ ì˜ ì¤‘ê³„ìž ì—­í• ì„ í•œë‹¤.
- weve peerëŠ” kube-apiserverì— ì£¼ê¸°ì ìœ¼ë¡œ pod ë° node ìƒíƒœë¥¼ requestí•¨ìœ¼ë¡œì¨ ì–´ë–¤ podê°€ ì–´ë–¤ nodeì— ì¡´ìž¬í•˜ëŠ” ì§€ì— ëŒ€í•œ ì •ë³´ë¥¼ ì–»ì–´ì™€ ë³´ê´€í•¨ìœ¼ë¡œì¨ 
- Weavenetê³¼ ê°™ì€ CNIì€ í´ëŸ¬ìŠ¤í„°ì— overlay network ì„ êµ¬ì„±í•˜ê²Œ ë˜ë©°, weave peerëŠ” overlay network bridgeë¥¼ ê° ë…¸ë“œì—ì„œ ìƒì„±í•œë‹¤.



=======
title: 'Docker ë„¤íŠ¸ì›Œí¬ êµ¬ì¡°'
date: '2024-02-27 11:00:00'
author: jjunyong
tags: network
categories: Linux í´ë¼ìš°ë“œ
---

- super user ê¶Œí•œ ì—†ì´ docker ì‚¬ìš©í•˜ê¸°

```bash
sudo usermod -aG docker {ê³„ì •ëª…}
```

- dockerì—ì„œ ì»¨í…Œì´ë„ˆ ìƒì„±í•˜ê³  ë‚´ë¶€ë¡œ ë“¤ì–´ê°€ê¸°

```bash
docker run --rm -it ubuntu:16.04 /bin/bash

# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ë¦¬ëˆ…ìŠ¤ ë²„ì „ í™•ì¸
cat /etc/issue
```

### ì»¨í…Œì´ë„ˆëž€?

- ì»¨í…Œì´ë„ˆëŠ” ë…ë¦½ëœ ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì´ë‹¤.
- ì»¨í…Œì´ë„ˆëŠ” ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ì´ë‹¤.
  ![image1](./image1.png)

### Docker êµ¬ì¡°

![image2](./image2.png)

- ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ê°€ 1ë²ˆì¸ daemon í”„ë¡œì„¸ìŠ¤ì˜ í˜•íƒœë¡œ dockerdëŠ” êµ¬ë™ëœë‹¤.
- docker CLI ëª…ë ¹ì€ dockerdì— ì „ë‹¬ëœë‹¤. ì „ë‹¬í•˜ëŠ” ë°©ì‹ì€ /var/run/docker.sock
- containerdê°€ container runtimeì´ë©° /run/containerd/containerd.sock ì„ í†µí•´ì„œ dockerdì™€ í†µì‹ í•œë‹¤.
- docker ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ CLIëª…ë ¹ì„ ì‚¬ìš©í•˜ê³ ìž í•˜ë©´ ì „ì²´ ì»¨í…Œì´ë„ˆì— ëŒ€í•œ ì •ë³´ë¥¼ dockerdë¥¼ í†µí•´ì„œ ì•Œì•„ë‚´ì•¼ í•˜ê¸° ë•Œë¬¸ì— í˜¸ìŠ¤íŠ¸ì˜ /var/run/docker.sockë¥¼ ë„ì»¤ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìžˆë„ë¡ ë§ˆìš´íŠ¸ë˜ì–´ì•¼ í•œë‹¤.
- dockerd, docker CLI í”„ë¡œì„¸ìŠ¤ëŠ” ì•„ëž˜ì™€ ê°™ì´ tmpfs íŒŒì¼ ì‹œìŠ¤í…œ ì¦‰, ë©”ëª¨ë¦¬ì— ì˜¬ë¼ê°„ docker.sockê³¼ í†µì‹ í•¨ìœ¼ë¡œì¨ ë¹ ë¥¸ I/O ì†ë„ë¥¼ ê°€ì ¸ê°„ë‹¤.
  ![image3](./image3.png)

### Docker in Docker

- docker CLI, dockerd, containerd, containerd-shim ê¸°ë™ ì¤‘ì¸ì§€ì— ëŒ€í•œ í™•ì¸
- ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ dockerì‚¬ìš© ì‹¤ìŠµ ( docker in docker )
  ![image4](./image4.png)

---

## ë„ì»¤ ë„¤íŠ¸ì›Œí¬ êµ¬ì¡°

- docker0ë¼ëŠ” ë¸Œë¦¿ì§€/ìŠ¤ìœ„ì¹˜ ìž¥ë¹„ë¥¼ swì ìœ¼ë¡œ êµ¬í˜„í•˜ê³  ìžˆë‹¤ê³  ë³´ë©´ ë¨.
- ì»¨í…Œì´ë„ˆëŠ” ë„¤íŠ¸ì›ì—ì„œ ê°œë³„ ì»´í“¨í„°ë¡œ ë³´ë©´ ë˜ëŠ”ë°, network interfaceê°€ hostì— 1ê°œê¸° ë•Œë¬¸ì— ê°€ìƒì˜ vethë¥¼ í†µí•´ì„œ ì»¨í…Œì´ë„ˆë“¤ì— ê°ê°ì˜ network interfaceë¥¼ ë¶€ì—¬í•˜ê²Œ ë¨
  ![image5](./image5.png)
- ë„ì»¤ ë„¤íŠ¸ì›Œí¬ í™•ì¸í•˜ê¸°

```bash
docker network ls
```

- ë‹¤ì–‘í•œ ì»¨í…Œì´ë„ˆì™€ docker0 ë¸Œë¦¿ì§€ ì—°ê²°í™•ì¸í•˜ê¸°
  ![image6](./image6.png)

- ì»¨í…Œì´ë„ˆì˜ gatewayì¸ docker0 ipì£¼ì†Œ í™•ì¸í•˜ê¸°
  ![image7](./image7.png)

- ì»¨í…Œì´ë„ˆ ë‚´ì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°íŽ˜ì´ìŠ¤ eth0 í™•ì¸í•˜ê¸°
  ![image8](./image8.png)

- ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆì˜ ë„¤íŠ¸ì›Œí¬ ipì£¼ì†Œ í™•ì¸í•˜ê¸°
  ![image9](./image9.png)

- ì»¨í…Œì´ë„ˆ ê°„ì˜ ë„¤íŠ¸ì› í†µì‹  í…ŒìŠ¤íŠ¸
  ![image10](./image10.png)

- ë…ë¦½ëœ ë„¤íŠ¸ì›Œí¬ ìƒì„± í›„ 2ê°œì˜ ì»¨í…Œì´ë„ˆ í†µì‹ 
  ![image11](./image11.png)
  ![image12](./image12.png)

- ë…ë¦½ëœ ë„¤íŠ¸ì›Œí¬ ìƒì„± í›„ 2ê°œì˜ ì»¨í…Œì´ë„ˆ í†µì‹  ë¬¸ì œí•´ê²°
  ![image13](./image13.png)
  ![image14](./image14.png)

- ìƒˆë¡œìš´ ë…ë¦½ëœ ë„¤íŠ¸ì›Œí¬ vs ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ë¹„êµ
  ![image15](./image15.png)
  ![image16](./image16.png)
>>>>>>> b0d776309854376c9f22aaa6572d7ec1fedd3ada
