---
emoji: ğŸ§¢
title: '[CKS] Cluster setup & hardening 1'
date: '2022-09-16 00:00:00'
author: jjunyong
tags: k8s
categories: DevOps
---

### Cloud Native ë³´ì•ˆì˜ 4C
- Cloud : Datacenter, network, servers
- Cluster : Auth, Admission, NP
- Container : Restrict image, supply chain, sandboxing, privileged
- Code : Code security

### CIS Benchmark
- CISëŠ” ì»¤ë®¤ë‹ˆí‹° ê¸°ë°˜ì˜ ì˜¤í”ˆì†ŒìŠ¤ ë‹¨ì²´ë¡œì„œ ì„¸ìƒì˜ ì‚¬ì´ë²„ ë³´ì•ˆì„ í–¥ìƒí•˜ëŠ” ë° ê¸°ì—¬í•œë‹¤. 
- CISëŠ” k8s ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ì–‘í•œ IT í‘œì¤€ ê¸°ìˆ ë“¤( web, was, db, OS, network )ì— ëŒ€í•´ì„œ ë³´ì•ˆì— ëŒ€í•œ best practiceë¥¼ ì œê³µí•œë‹¤.
- CIS-CATì„ ì‚¬ìš©í•˜ë©´ í˜„ì¬ k8s í´ëŸ¬ìŠ¤í„°ì˜ ì·¨ì•½ì ì„ htmlë¡œ ìƒì„±í•´ì¤€ë‹¤. 
  - ê·¸ëŸ¬ë‚˜ CIS-CAT proë§Œ k8s assessmentë¥¼ ì§€ì›í•˜ë©° ìœ ë£Œì´ë‹¤. 

### Lab : CIS benchmark on Ubuntu OS (CIS-CAT)
- CIS-CAT ì‹¤í–‰ 
  - `sh ./Assessor-CLI.sh -i -rd /var/www/html/ -nts -rp index`
  - OS ì„ íƒ Ubuntu 20.04 LTS 
  - Profile ì„ íƒ : Level1 - server
ì´ë ‡ê²Œ í•˜ë©´ /var/www/html ê²½ë¡œì— index.html íŒŒì¼ë¡œ í˜„ì¬ ì„¤ì¹˜ëœ OSì¸ ubuntu 20.04 ì— ëŒ€í•œ ì·¨ì•½ì  ë³´ê³ ì„œê°€ ìƒì„±ë˜ë©° ë³´ê³ ì„œì˜ remediationì„ ì°¸ê³ í•˜ì—¬ ë³´ì•ˆì— í•„ìš”í•œ ì„¤ì •ì„ ì¡°ì¹˜í•˜ë©´ ëœë‹¤. 

### Lab : Kube-bench
- kube-bench ì„¤ì¹˜ 
```bash
curl -L https://github.com/aquasecurity/kube-bench/releases/download/v0.4.0/kube-bench_0.4.0_linux_amd64.tar.gz -o kube-bench_0.4.0_linux_amd64.tar.gz
tar -xvf kube-bench_0.4.0_linux_amd64.tar.gz
```
- kube-bench test
```bash
./kube-bench --config-dir `pwd`/cfg --config `pwd`/cfg/config.yaml
```
  - controlplane, worker, master, etcd ë“± k8s ì£¼ìš” ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•œ security í•­ëª© pass/fail ê²°ê³¼ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤. 

- kube-bench test ê²°ê³¼ì˜ ê°€ì´ë“œì— ë”°ë¥¸ ì·¨ì•½ì  ì¡°ì¹˜ 
  - ì£¼ë¡œ static pod ( kube-scheduler, kube-controller-manger)
  

## K8S Security Primitive 
Kube-apiserverê°€ ê±°ì˜ ëŒ€ë¶€ë¶„ì˜ cluster ì‘ì—…ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ì´ê²ƒìœ¼ë¡œì˜ ì ‘ê·¼ì„ ì œì–´í•˜ê³  ê¶Œí•œì„ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ë§¤ìš° ì¤‘ìš”í•˜ë‹¤. 

### Authentication ( who can access ?)
#### Users
- k8sëŠ” ì§ì ‘ 'user'ë¼ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤. 
- username, password/token ì— ëŒ€í•œ íŒŒì¼ì„ kube-apiserverê°€ ì°¸ì¡°í•˜ì—¬ ì¸ì¦í•˜ë„ë¡ í•  ìˆ˜ ìˆì§€ë§Œ ê¶Œì¥ë˜ì§€ëŠ” ì•ŠëŠ” ë°©ë²•ì´ë©° ìµœì‹  k8sì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•ŠëŠ”ë‹¤.  
#### serviceaccount
- Prometheus, Jenkins, k8s dashboardì™€ ê°™ì´ ë‹¤ë¥¸ applicationì—ì„œ kube-apiserverì™€ ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•  ë•Œ serviceaccountë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•œë‹¤. 
- serviceaccountë¥¼ ìƒì„±í•˜ë©´ secretìœ¼ë¡œ í† í°ê°’ì„ ê´€ë¦¬í•˜ë©°, saëŠ” ì´ë¥¼ ì°¸ì¡°í•œë‹¤. curlë¡œ api-serverì— ì ‘ì† ì‹œì—ëŠ” ì´ í† í° ê°’ì„ header authorizationì— bearerë¡œ ë„£ì–´ì£¼ë©´ ì¸ì¦ì´ ê°€ëŠ¥í•´ì§„ë‹¤. 
- 3rd party applicationì´ í´ëŸ¬ìŠ¤í„° ë‚´ì— ì¡´ì¬í•œë‹¤ë©´, podì— volumeìœ¼ë¡œì„œ saì˜ secretì„ mountí•´ì£¼ë©´ ìë™ ì¸ì¦ì´ ëœë‹¤. 
- ëª¨ë“  k8sì˜ namespaceì—ëŠ” 'default serviceaccount' ê°€ ìë™ ìƒì„±ë˜ë©° podë¥¼ ë„ìš°ê²Œ ë˜ë©´ ë³„ë„ ëª…ì‹œí•´ì£¼ì§€ ì•Šì•„ë„ podì— saì˜ secretê³¼ tokenì´ ìë™ìœ¼ë¡œ ë§ˆìš´íŠ¸ ë˜ì—ˆë‹¤. 

#### Serviceaccountì˜ ë³€í™” : v1.22, v1.24
- v1.22 
  - v1.22 ì´ì „ì—ëŠ” serviceaccountê°€ ìƒì„± ì‹œ secretì´ ìë™ ìƒì„±ë˜ë©° secretì€ token ê°’ì„ ë‚´í¬í•˜ê³  ìˆì—ˆë‹¤. ì´ê²ƒì€ expirationì´ ë”°ë¡œ ì—†ê³  íŠ¹ì • ì‚¬ìš©ìì— ê·€ì†ëœ ê²ƒë„ ì•„ë‹ˆì—ˆë‹¤. podë¥¼ ìƒì„±í•˜ë©´ ìë™ìœ¼ë¡œ default serviceaccountì˜ secretì´ podì— ë§ˆìš´íŠ¸ ë˜ì–´ì„œ ì¸ì¦ì— ì‚¬ìš©ë˜ëŠ” ë°©ì‹ì´ì—ˆë‹¤. 
  - ê·¸ëŸ¬ë‚˜ v1.22 ë¶€í„°ëŠ” 'Token request API' ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ê°œì„ ë˜ì—ˆë‹¤. 
    ![image2](./image2.png)
  - serviceaccount admission controllerê°€ Token request APIë¡œë¶€í„° ì–»ì€ í† í°ì„ projected volumeìœ¼ë¡œ podì— ìœ„ì™€ ê°™ì´ ë§ˆìš´íŠ¸ ì‹œì¼œ ì£¼ê²Œ ë˜ì—ˆë‹¤.
- v1.24   
  - ê·¸ë¦¬ê³  ë‚˜ì•„ê°€ì„œ v1.24 ë¶€í„°ëŠ” serviceaccountë¥¼ ìƒì„± ì‹œì— secretê³¼ tokenì´ ìƒì„±ë˜ì§€ ì•Šê³ , `kubectl create token <sa-name>` ì„ í•´ì•¼ í•´ë‹¹ saì— ëŒ€í•œ tokenì´ expiryë¥¼ ê°€ì§€ê³  ìƒì„±ë˜ê²Œ ë˜ì—ˆë‹¤. 
  - ì˜ˆì „ ë°©ì‹ ëŒ€ë¡œ secretì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ í•˜ë©´ ëœë‹¤.
    ![image1](./image1.png)

ì•„ë˜ì™€ ê°™ì´ serviceaccountë¥¼ ì„¤ì •í•˜ë©´ 7ì¼ ë™ì•ˆ í† í°ì´ ìœ ì§€ë˜ê³  7ì¼ ë’¤ ìë™ìœ¼ë¡œ ìƒˆë¡œìš´ í† í°ìœ¼ë¡œ ê°±ì‹ í•˜ê²Œ ëœë‹¤. ê·¸ë¦¬ê³  automountServiceAccountToken ì„¤ì •ì„ trueë¡œ í•˜ë©´ ìë™ìœ¼ë¡œ podì— í† í°ì„ ë§ˆìš´íŠ¸í•˜ê²Œ ëœë‹¤. 

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-service-account
automountServiceAccountToken: true
expirationSeconds: 604800 # 7ì¼ ë™ì•ˆ í† í°ì„ ìœ ì§€
```

> ì°¸ê³ : ( https://kubernetes.io/docs/concepts/configuration/secret/#service-account-token-secrets )
>Kubernetes ë²„ì „ 1.22 ì´ì „ì—ì„œëŠ” Kubernetes APIì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•œ ìê²© ì¦ëª…ì„ ìë™ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ì´ì „ ë©”ì»¤ë‹ˆì¦˜ì€ ì‹¤í–‰ ì¤‘ì¸ Podì— ë§ˆìš´íŠ¸í•  ìˆ˜ ìˆëŠ” í† í° Secretsë¥¼ >ìƒì„±í•˜ëŠ” ê²ƒì„ ê¸°ë°˜ìœ¼ë¡œ í–ˆìŠµë‹ˆë‹¤. ë” ìµœê·¼ ë²„ì „ì¸ Kubernetes v1.28ì„ í¬í•¨í•œ Kubernetesì˜ ìµœì‹  ë²„ì „ì—ì„œëŠ” API ìê²© ì¦ëª…ì„ ì§ì ‘ TokenRequest APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì–»ê³ , í”„ë¡œì íŠ¸ëœ >ë³¼ë¥¨ì„ ì‚¬ìš©í•˜ì—¬ Podsì— ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤. ì´ ë°©ë²•ìœ¼ë¡œ ì–»ëŠ” í† í°ì€ ì œí•œëœ ìˆ˜ëª…ì„ ê°€ì§€ë©°, í•´ë‹¹ Podê°€ ì‚­ì œë  ë•Œ ìë™ìœ¼ë¡œ ë¬´íš¨í™”ë©ë‹ˆë‹¤.
>
>ì—¬ì „íˆ í† í°ì´ ë§Œë£Œë˜ì§€ ì•ŠëŠ” í† í°ì´ í•„ìš”í•œ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê³„ì • í† í° Secretì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ APIì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•œ í† í°ì„ ì–»ê¸° ìœ„í•´ TokenRequest í•˜ìœ„ ë¦¬ì†ŒìŠ¤ë¥¼  >ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤. kubectl create token ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ TokenRequest APIì—ì„œ í† í°ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### TLS 
- ë¹„ëŒ€ì¹­í‚¤ ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”í•œë‹¤. 
  - private key ì™€ public Lock ìœ¼ë¡œ ìƒê°í•˜ë©´ ì‰½ë‹¤.
- SSHì˜ ë¹„ëŒ€ì¹­í‚¤ ì•”í˜¸í™” ë°©ì‹ í™œìš©ì˜ˆ 
  - ìë¬¼ì‡ ì¸ ê³µê°œí‚¤ë¥¼ ì„œë²„ì— ë‘ê³  ì„œë²„ì— ì ‘ì†í•˜ë ¤ëŠ” ì‚¬ìš©ìëŠ” ê°œì¸í‚¤ë¥¼ ê°€ì§€ê³  ì„œë²„ì— ì ‘ê·¼í•œë‹¤. 
  ![image3](./image3.png)
- httpsì˜ ê²½ìš° ì´ë³´ë‹¤ ë‹¤ì†Œ ë³µì¡í•˜ë‹¤. ëŒ€ì¹­í‚¤, ë¹„ëŒ€ì¹­í‚¤ ì•”í˜¸í™” ë°©ì‹ì„ ëª¨ë‘ ì‚¬ìš©í•œë‹¤.
  - ëŒ€ì¹­í‚¤ë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•´ì„œ ë¹„ëŒ€ì¹­í‚¤ ì•”í˜¸í™” ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤.
  - ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•  ë•ŒëŠ” í´ë¼ì´ì–¸íŠ¸/ì„œë²„ì—ì„œ ë™ì¼í•œ ê°œì¸í‚¤ë¡œ ì•”/ë³µí˜¸í™”í•œë‹¤. 

### HTTPSì˜ TLS ë™ì‘ ì›ë¦¬ 

![image4](./image4.png)
1. ssh-keygenì—ì„œ í–ˆë˜ ê²ƒê³¼ ìœ ì‚¬í•˜ê²Œ openssl ëª…ë ¹ì„ í™œìš©í•˜ì—¬ ì„œë²„ì—ì„œ ê°œì¸í‚¤/ê³µê°œí‚¤ë¥¼ ìƒì„±í•œë‹¤. 
2. ì‚¬ìš©ìê°€ ì²˜ìŒ ì›¹ ì„œë²„ì— ì ‘ê·¼ í•  ë•Œ ì‚¬ìš©ìëŠ” ì„œë²„ë¡œë¶€í„° 1ì—ì„œ ìƒì„±í•œ ê³µê°œí‚¤ë¥¼ ì „ë‹¬ë°›ëŠ”ë‹¤. 
  - ì´ ë•Œ ê³µê°œí‚¤ë¥¼ ì „ë‹¬ ë°›ì„ ë•Œ 'ì¸ì¦ì„œ'ì•ˆì— ë‹´ì•„ì„œ ì „ë‹¬ ë°›ë„ë¡ í•œë‹¤. ê·¸ ì´ìœ ëŠ” ë’¤ì— ë‚˜ì˜¨ë‹¤. 
3. ì‚¬ìš©ìëŠ” ëŒ€ì¹­í‚¤ë¥¼ ì„œë²„ë¡œë¶€í„° ë°›ì€ ê³µê°œí‚¤ë¡œ ì•”í˜¸í™”í•˜ì—¬ ì„œë²„ë¡œ ì „ë‹¬í•œë‹¤. 
4. í•´ì»¤ëŠ” ê³µê°œí‚¤ì— ëŒ€í•œ ê°œì¸í‚¤ê°€ ì—†ì„ ê²ƒì´ë¯€ë¡œ ëŒ€ì¹­í‚¤ë¥¼ ì•Œì•„ë‚¼ ìˆ˜ ì—†ê³ , ì„œë²„ëŠ” ê°€ì§€ê³  ìˆëŠ” ê°œì¸í‚¤ë¡œ ë³µí˜¸í™”í•˜ì—¬ ëŒ€ì¹­í‚¤ë¥¼ ë“í•œë‹¤.

ê·¸ëŸ¬ë‚˜ ë˜ ë‹¤ë¥¸ ë¬¸ì œê°€ ë‚¨ì•„ ìˆë‹¤. ë§Œì•½ì— í•´ì»¤ê°€ ì‹ ë¢°í•  ë§Œí•œ ì„œë²„ì¸ ê²ƒì²˜ëŸ¼ ì‚¬ì´íŠ¸ UIë“±ì„ ì†ì—¬ì„œ ì‚¬ìš©ìê°€ í•´ë‹¹ ì‹œìŠ¤í…œì— ì ‘ì†í•˜ëŠ” ë° ì„±ê³µí•˜ê²Œ í–ˆë‹¤ê³  ê°€ì •í•˜ì.
ê·¸ë ‡ë‹¤ë©´ ì‚¬ìš©ìëŠ” í•´ì»¤ ì„œë²„ë¡œë¶€í„° ê³µê°œí‚¤ë¥¼ ì „ë‹¬ë°›ê²Œ ëœë‹¤. ì´ ë•Œ ì•ì„œ ì–¸ê¸‰í–ˆë“¯ì´ ì¸ì¦ì„œë¥¼ í†µí•´ í•´ë‹¹ ê³µê°œí‚¤ë¥¼ ì „ë‹¬í•¨ìœ¼ë¡œì¨ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œìœ¼ë¡œë¶€í„° ì˜¨ ê²ƒì¸ì§€ë¥¼ ê²€ì¦í•  ìˆ˜ ìˆë‹¤. 
ì¸ì¦ì„œì—ëŠ” ì•„ë˜ì™€ ê°™ì€ ì •ë³´ê°€ ë‹´ê²¨ ìˆë‹¤.
![image5](./image5.png)

ê·¸ëŸ¬ë‚˜ ë˜ ì—¬ì „íˆ ë¬¸ì œê°€ ë‚¨ì•„ìˆë‹¤. í•´ì»¤ê°€ certificate ê¹Œì§€ ìê¸° ì„ì˜ë¡œ ë§Œë“¤ì–´ì„œ ì†ì¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤. ì´ë¥¼ self-signed certificateì´ë¼ê³  í•œë‹¤. ëª¨ë“  ë¸Œë¼ìš°ì €ëŠ” ì¸ì¦ì„œê°€ ì‹ ë¢°í• ë§Œí•œ CAë¡œë¶€í„° signëœ ì¸ì¦ì„œì¸ì§€ë¥¼ ì²´í¬í•˜ë„ë¡ ë§Œë“¤ì–´ì ¸ ìˆë‹¤. 

ê·¸ë˜ì„œ ì•„ë˜ì™€ ê°™ì´ Symantecê³¼ ê°™ì€ CA(Certificate Authority) ê¸°ê´€ì— CSR(Certificate Signing Request)ì„ í†µí•´ ì¸ì¦ì„œë¥¼ signë°›ê²Œ ëœë‹¤.  
![image6](./image6.png)

ë¸Œë¼ìš°ì €ëŠ” ì–´ë–»ê²Œ ê°€ì§œ CAê°€ ì•„ë‹Œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” CAë¡œë¶€í„° signëœ ê²ƒì¸ì§€ë¥¼ ì•Œ ìˆ˜ ìˆëŠ”ê°€? CAë“¤ì€ ëª¨ë‘ ê°ì ê°œì¸í‚¤/ê³µê°œí‚¤ ìŒì„ ì§€ë‹ˆê³  ìˆê³  **ì¸ì¦ì„œë¥¼ signí•  ë•ŒëŠ” CAìì²´ ê°œì¸í‚¤ë¥¼ ì‚¬ìš©í•œë‹¤.** ê·¸ë¦¬ê³  ëª¨ë“  CAë“¤ì˜ ê³µê°œí‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ë¹ŒíŠ¸ì¸ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì´ë¥¼ ì´ìš©í•˜ì—¬ ì¸ì¦ì„œê°€ ì •ë§ë¡œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” CAë¡œë¶€í„° ì‚¬ì¸ë˜ì—ˆëŠ”ì§€ë¥¼ ê²€ì¦í•œë‹¤. 
![image7](./image7.png)

> ì—”í„°í”„ë¼ì´ì¦ˆ í™˜ê²½ì—ì„œëŠ” private CA ì„œë²„ë¥¼ êµ¬ì¶•í•˜ì—¬ CAì˜ ê³µê°œí‚¤ë¥¼ ì§ì›ë“¤ì˜ ë¸Œë¼ìš°ì €ì— ë¹ŒíŠ¸ì¸ ì‹œí‚¤ê³  ì¸ì¦ì„œë¥¼ private CAë¡œë¶€í„° signë°›ê²Œ í•˜ëŠ” ë“± ìì²´ì ìœ¼ë¡œ CAë¥¼ êµ¬ì¶•í•  ìˆ˜ë„ ìˆë‹¤. 

ì´ëŸ¬í•œ ëª¨ë“  ì¼ë ¨ì˜ í™˜ê²½ì™€ êµ¬ì¡°ë¥¼ ê°€ë¦¬ì¼œ PKIë¼ê³  í•œë‹¤. 
![image8](./image8.png)

#### Naming convention
- ê³µê°œí‚¤ë¥¼ ì§€ë‹ˆëŠ” ì¸ì¦ì„œëŠ” ë³´í†µ .pem, .crt í™•ì¥ìë¥¼ ì§€ë‹Œë‹¤. 
- ê°œì¸í‚¤ëŠ” ë³´í†µ .key, -key.pemì˜ í™•ì¥ìë¥¼ ì§€ë‹Œë‹¤. 

<br>

---
<u>**HTTPS ì•”í˜¸í™” í†µì‹ ì˜ ì›ë¦¬ë¥¼ ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.**</u>
1. openssl ëª…ë ¹ì„ í™œìš©í•˜ì—¬ ì„œë²„ì—ì„œ ê°œì¸í‚¤/ê³µê°œí‚¤ë¥¼ ìƒì„±í•œë‹¤. ì—¬ê¸°ì„œ ê³µê°œí‚¤ëŠ” ê³§ ì¸ì¦ì„œë¥¼ ì˜ë¯¸í•œë‹¤. 
2. CAì—ì„œë„ ê°œì¸í‚¤/ê³µê°œí‚¤ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©° ì„œë²„ì—ì„œëŠ” CSRì„ í†µí•´ 1ì—ì„œ ìƒì„±í•œ ìì‹ ì˜ ì¸ì¦ì„œ(ê³µê°œí‚¤)ë¥¼ signí•´ì¤„ ê²ƒì„ CA ì„œë²„ì— ìš”ì²­í•œë‹¤.
3. CAì„œë²„ì—ì„œëŠ” CAê°œì¸í‚¤ë¥¼ í†µí•´ ì¸ì¦ì„œë¥¼ signí•˜ì—¬ ìš”ì²­í•œ ì›¹ ì„œë²„ì— ì „ë‹¬í•´ì¤€ë‹¤. 
4. ì´í›„ í´ë¼ì´ì–¸íŠ¸ê°€ ì›¹ ì„œë²„ì— ì ‘ê·¼ í•˜ë ¤ê³  í•  ë•Œ ì‚¬ìš©ìëŠ” ì„œë²„ë¡œë¶€í„° signëœ ì¸ì¦ì„œ(ê³µê°œí‚¤)ë¥¼ ì „ë‹¬ë°›ê²Œ ëœë‹¤.
5. ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œëŠ” CAê³µê°œí‚¤ë¥¼ ì§€ë‹ˆê³  ìˆê¸°ì— ì´ë¥¼ í™œìš©í•˜ì—¬ 4ì—ì„œ ì „ë‹¬ë°›ì€ ì¸ì¦ì„œê°€ ìœ íš¨í•œì§€ë¥¼ ì²´í¬í•œë‹¤. 
6. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë©”ì‹œì§€ ì•”ë³µí˜¸í™”ë¥¼ ìœ„í•œ ëŒ€ì¹­í‚¤ë¥¼ ìƒì„±í•œë‹¤. 
7. í´ë¼ì´ì–¸íŠ¸ëŠ” ëŒ€ì¹­í‚¤ë¥¼ ì„œë²„ë¡œë¶€í„° ë°›ì€ ì¸ì¦ì„œ(ê³µê°œí‚¤)ë¡œ ì•”í˜¸í™”í•˜ì—¬ ì„œë²„ë¡œ ì „ì†¡í•œë‹¤.
8. ì„œë²„ëŠ” ì§€ë‹ˆê³  ìˆëŠ” ê°œì¸í‚¤ë¡œ (1ì—ì„œ ìƒì„±í•œ) ë³µí˜¸í™”í•˜ì—¬ ëŒ€ì¹­í‚¤ë¥¼ ë“í•œë‹¤.
9. ì‚¬ìš©ìëŠ” ì•ìœ¼ë¡œ ì„œë²„ì™€ í†µì‹ í•  ë•Œ ê°œì¸í‚¤ë¡œ ì•”í˜¸í™”í•´ì„œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ë©° ì„œë²„ëŠ” 7ì—ì„œ ìµœì¢…ì ìœ¼ë¡œ ë“í•œ ëŒ€ì¹­í‚¤ë¥¼ í™œìš©í•˜ì—¬ ë³µí˜¸í™”í•¨ìœ¼ë¡œì¨ ì•ˆì „í•œ ë³´ì•ˆ í†µì‹ ì´ ê°€ëŠ¥í•˜ê²Œ ë˜ì—ˆë‹¤. 
---

### Kubernetesì—ì„œì˜ TLS
#### Server ì¸ì¦ì„œ
- Kube-api server
  - apiserver.crt
  - apiserver.key
- ETCD server
  - etcdserver.crt
  - etcdserver.key
- Kubelet server
  - kubelet.crt
  - kubelet.key

#### Client ì¸ì¦ì„œ
- Admin ìœ ì €
  - admin.crt
  - admin.key
- Kube-scheduler
- Kube-controller-manager
- Kube-proxy
- kube-apiserverëŠ” ETCD serverì— ëŒ€í•œ ìœ ì¼í•œ clientì´ë©° kubeletì— ëŒ€í•œ clientì´ê¸°ë„ í•˜ë‹¤.
- kubeletì€ ë˜í•œ kube-apiserverì— ëŒ€í•œ client ì´ê¸°ë„ í•˜ë‹¤. 

![image9](./image9.png)
![image10](./image10.png)

ì´ëŸ¬í•œ ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ì„œëŠ” CAê°€ í•„ìš”í•œë°, k8sì—ì„œëŠ” ìµœì†Œ 1ê°œ ì´ìƒì˜ CAë¥¼ ìš”êµ¬í•œë‹¤. ETCD ì„œë²„ë¥¼ ìœ„í•œ ë³„ë„ì˜ CAë¥¼ ë‘ê¸°ë„ í•œë‹¤. 
ê·¸ë¦¬ê³  CAëŠ” CAë§Œì˜ certificate(ê³µì¸í‚¤)ì™€ key(ê°œì¸í‚¤)ë¥¼ ì§€ë‹Œë‹¤. 

#### ì¸ì¦ì„œ ìƒì„±í•˜ê¸° 
openssl ëª…ë ¹ì„ ì‚¬ìš©í•œë‹¤.

- CAì—ì„œì˜ ì‘ì—… 
  - 1) Key ìƒì„±
    ```bash
      openssl genrsa -out ca.key 2048
    ```
  - 2) CSR ( Certificate Signing Request ) ìƒì„±
    ```bash
      openssl req -new -key ca.key -subj "/CN=KUBERNETES-CA" -out ca.csr
    ```
  - 3) Certificate Signí•˜ê¸° ( self-sign )
    ```bash
      openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt
    ```
ì´ì œ CAëŠ” private keyì™€ root ì¸ì¦ì„œë¥¼ ê°€ì§€ê²Œ ë˜ì—ˆë‹¤.

- Admin ì‚¬ìš©ìì—ì„œì˜ ì‘ì—… ( Client )
  - 1) Key ìƒì„±
    ```bash
      openssl genrsa -out adin.key 2048
    ```
  - 2) CSR ìƒì„±
     ```bash
      openssl req -new -key admin.key -subj "/CN=kube-admin/O=system:masters" -out admin.csr
    ```
      - /O=system:mastersëŠ” admin ì‚¬ìš©ìì˜ ê¶Œí•œ ë¶€ì—¬ë¥¼ ìœ„í•´ í•„ìš”í•œ êµ¬ë¬¸ì´ë‹¤. 

    - kube-admin ì´ë¼ê³  ì ì–´ì¤€ ê²ƒì€ adminì— ëŒ€í•œ ë„¤ì´ë°ì„ í•œ ê²ƒì´ë©° ì–´ë–¤ ì´ë¦„ì´ë“  ìƒê´€ì—†ë‹¤.
  - 3) Certificate Sign ( CA-sign )
    ```bash
      openssl x509 -req -in admin.csr -CA ca.crt -CAkey ca.key -out admin.crt
    ```

admin ìœ ì € ë¿ë§Œ ì•„ë‹ˆë¼ kube-proxy, scheduler ë“±ì˜ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ë„ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ client certificateì„ ë°œê¸‰í•œë‹¤. 

ì•ì„œ ì›¹ë¸Œë¼ìš°ì €ì˜ TLSì— ëŒ€í•´ì„œ ì–˜ê¸°í•  ë•Œ ëª¨ë“  ë¸Œë¼ìš°ì €ëŠ” CAì˜ ê³µê°œí‚¤(public certificate)ì„ ì§€ë‹ˆê³  ìˆì–´ì„œ ì„œë²„ë¡œë¶€í„° ë°›ì€ certificateì„ í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ ìœ íš¨í•œì§€ ê²€ì¦í•  ìˆ˜ ìˆë‹¤ê³  í•œ ê²ƒì²˜ëŸ¼, k8sì—ì„œë„ kuberenets-CAê°€ ë°œê¸‰í•œ public certificateì„ ëª¨ë“  clientë“¤ì´ ê°€ì§€ê³  ìˆì–´ì•¼ í•œë‹¤.
  ![image11](./image11.png)

- Kube-apiserver ì—ì„œì˜ ì‘ì—… ( Server )  : ì•„ë˜ ê·¸ë¦¼ ì°¸ì¡° 
  - 1) Key ìƒì„±
  - 2) CSR ìƒì„±
  - 3) Certificate Sign ( CA-sign )

![image12](./image12.png)
  - kube-apiserverì—ì„œ ì´ë ‡ê²Œ ìƒì„±ëœ keyë“¤ì€ ì–´ë–»ê²Œ ì„¤ì •ë˜ëŠ”ê°€? 
    ![image13](./image13.png)
    <br>
    - ìœ„ ê·¸ë¦¼ì˜ ì„¤ì •ì—ì„œ ë³¼ ìˆ˜ ìˆëŠ” ê²ƒì²˜ëŸ¼ apiserverëŠ” ETCD, Kubeletì— ëŒ€í•˜ì—¬ëŠ” clientì´ê¸° ë•Œë¬¸ì— ê°ê°ì˜ ì»´í¬ë„ŒíŠ¸ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ client certificate, keyë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ í•œë‹¤
    - client-ca-fileì—ì„œëŠ” apiserverë¡œ ì ‘ê·¼í•˜ë ¤ëŠ” clientê°€ ê°€ì§€ê³  ìˆì–´ì•¼ í•  caì¸ì¦ì„œì— ëŒ€í•œ ì •ë³´ë¥¼ ì„¤ì •í•˜ê³  ìˆë‹¤.
    - ETCD, kubelet ê´€ë ¨í•œ ca ì„¤ì •ì—ì„œë„ ë™ì¼í•œ ê²½ë¡œì˜ caì¸ì¦ì„œ ì •ë³´ë¡œ ì„¤ì •í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤. ë™ì¼ í´ëŸ¬ìŠ¤í„°ì—ì„œ CA ì¸ì¦ì„œëŠ” ëª¨ë‘ ë™ì¼í•˜ê¸° ë•Œë¬¸ì´ë‹¤.
    - tls-cert-file,, tls-private-keyì—ì„œëŠ” apiserverì˜ ì„œë²„ crt, ì„œë²„ keyì— ëŒ€í•´ì„œ ì„¤ì •í•œë‹¤.

- Kubeletì—ì„œì˜ ì‘ì—…, ì„¤ì • 
  - kubelet-configì—ì„œ yamlë¡œ ì„¤ì •í•˜ì—¬ ê´€ë¦¬í•˜ë©° kube-apiserverì— ëŒ€í•œ kubeletì˜ client certificateë„ ë§ˆì°¬ê°€ì§€ë¡œ ì—¬ê¸°ì„œ ê´€ë¦¬í•œë‹¤. 
    ![image14](./image14.png)
  
#### Cluster ë‚´ì˜ ì¸ì¦ì„œ í™•ì¸í•˜ê¸° 
- ì§ì ‘ ì„¤ì •í•˜ê¸° vs kubeadm
- kubeadmìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹ í–ˆì„ ë•Œ ì¸ì¦ì„œ ê´€ë ¨ëœ ì„¤ì •ì´ ì–´ë””ì— ìˆëŠ” ì§€ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.
![image15](./image15.png)
- kubeadm í™˜ê²½ìœ¼ë¡œ í–ˆì„ ë•ŒëŠ” static podì˜ logë¥¼ ë³´ê³  ì„¤ì •ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 
- kube-apiserver, etcdê°™ì€ê²Œ ì£½ì—ˆì„ ë•ŒëŠ” docker ëª…ë ¹ìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ë“¤ì—¬ë‹¤ ë´ì•¼ í•  ìˆ˜ ìˆë‹¤. 

#### Certificate API
- k8sëŠ” csr objectë¥¼ ì‚¬ìš©í•˜ì—¬ k8s ë¦¬ì†ŒìŠ¤ë¡œì„œ ì‚¬ìš©ì ë³„ë¡œ csrë¥¼ ê´€ë¦¬í•˜ê³  ê·¸ ì—­í• ì„ controller-managerê°€ í•œë‹¤.
- k8sì—ì„œ CAë€ CA key, crt íŒŒì¼ ê·¸ ìì²´ì´ë©° ì´ íŒŒì¼ë“¤ì„ ë³´ê´€í•˜ê³  ìˆëŠ” master nodeê°€ ê³§ CA ì„œë²„ì´ë‹¤.
