{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/querydsl1/",
    "result": {"data":{"cur":{"id":"07225a26-452a-50a8-b7ed-3903a7f9b9bb","html":"<h2 id=\"1-querydsl이란\" style=\"position:relative;\"><a href=\"#1-querydsl%EC%9D%B4%EB%9E%80\" aria-label=\"1 querydsl이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. QueryDSL이란?</h2>\n<p><strong>QueryDSL은 Java 코드로 쿼리를 짜서 DB에 접근하는 방식이다.</strong></p>\n<p>기존 데이터 접근 방식인 jdbcTemplate, Mybatis 와 같은 방법에서는 직접 SQL 쿼리를 짜야만 했다.</p>\n<p>JPA에서는 Spring data jpa를 통해서 조회 조건이 간단한 쿼리 같은 경우에는 별도의 쿼리를 짜지 않고도 DB로부터 데이터를 불러 올 수 있었다.</p>\n<p>그러나 복잡한 조회가 필요할 경우 불가피하게 JPQL을 통해서 아래와 같이 쿼리를 직접 짜야 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">jpql</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">String</span> username <span class=\"token operator\">=</span> <span class=\"token string\">\"jang\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">String</span> query <span class=\"token operator\">=</span> <span class=\"token string\">\"select m from Memberqwer m where m.username = :username\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> em<span class=\"token punctuation\">.</span><span class=\"token function\">createQuery</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResultList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그러나 QueryDSL을 사용하면 아래와 같이 자바코드의 형태로 쿼리를 짤 수 있고 여러가지 장점이 있다.</p>\n<ul>\n<li>컴파일 타임에서 에러를 잡을 수 있다.</li>\n<li>코드 자동 완성의 도움을 받을 수 있다.</li>\n<li>동적쿼리를 편하게 짤 수 있도록 도움을 준다.</li>\n<li>메소드를 뽑아 낼 수 있어 재사용이 가능하다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">querydsl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">String</span> username <span class=\"token operator\">=</span> <span class=\"token string\">\"jang\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> queryFactory\n        <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token function\">usernameeq</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">BooleanExpression</span> <span class=\"token function\">usernameEq</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> member<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>Spring data JPA와 QueryDSL을 함께 활용하면 RDB를 사용한 개발환경에서\n개발자는 자바를 통해 쿼리를 자유롭게 짤 수 있고, 핵심 비즈니스 로직에 집중할 수 있게 된다.</p>\n<h2 id=\"2-환경설정--gradle-\" style=\"position:relative;\"><a href=\"#2-%ED%99%98%EA%B2%BD%EC%84%A4%EC%A0%95--gradle-\" aria-label=\"2 환경설정  gradle  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 환경설정 ( gradle )</h2>\n<p>기존에 jpa를 사용하던 스프링부트 프로젝트 기준으로 아래와 같은 내용을 build.gradle에 추가해주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token comment\">// 1. queryDsl version 정보 추가</span>\nbuildscript <span class=\"token punctuation\">{</span>\n    ext <span class=\"token punctuation\">{</span>\n        queryDslVersion <span class=\"token operator\">=</span> <span class=\"token string gstring\">\"5.0.0\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nplugins <span class=\"token punctuation\">{</span>\n    id <span class=\"token string\">'org.springframework.boot'</span> version <span class=\"token string\">'2.6.3'</span>\n    id <span class=\"token string\">'io.spring.dependency-management'</span> version <span class=\"token string\">'1.0.11.RELEASE'</span>\n    <span class=\"token comment\">// 2. querydsl plugins 추가</span>\n    id <span class=\"token string gstring\">\"com.ewerk.gradle.plugins.querydsl\"</span> version <span class=\"token string gstring\">\"1.0.10\"</span>\n    id <span class=\"token string\">'java'</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//...</span>\n\ndependencies <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 3. querydsl dependencies 추가</span>\n    implementation <span class=\"token string gstring\">\"com.querydsl:querydsl-jpa:<span class=\"token expression\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>queryDslVersion<span class=\"token punctuation\">}</span></span>\"</span>\n    implementation <span class=\"token string gstring\">\"com.querydsl:querydsl-apt:<span class=\"token expression\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>queryDslVersion<span class=\"token punctuation\">}</span></span>\"</span>\n    <span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span>\n\ntest <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">useJUnitPlatform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">/*\n * 4. queryDSL 설정 추가\n */</span>\n<span class=\"token comment\">// querydsl에서 사용할 경로 설정</span>\n<span class=\"token keyword\">def</span> querydslDir <span class=\"token operator\">=</span> <span class=\"token string gstring\">\"<span class=\"token expression\"><span class=\"token punctuation\">$</span>buildDir</span>/generated/querydsl\"</span>\n<span class=\"token comment\">// JPA 사용 여부와 사용할 경로를 설정</span>\nquerydsl <span class=\"token punctuation\">{</span>\n    jpa <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    querydslSourcesDir <span class=\"token operator\">=</span> querydslDir\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// build 시 사용할 sourceSet 추가</span>\nsourceSets <span class=\"token punctuation\">{</span>\n    main<span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>srcDir querydslDir\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// querydsl 컴파일시 사용할 옵션 설정</span>\ncompileQuerydsl<span class=\"token punctuation\">{</span>\n    options<span class=\"token punctuation\">.</span>annotationProcessorPath <span class=\"token operator\">=</span> configurations<span class=\"token punctuation\">.</span>querydsl\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// querydsl 이 compileClassPath 를 상속하도록 설정</span>\nconfigurations <span class=\"token punctuation\">{</span>\n    compileOnly <span class=\"token punctuation\">{</span>\n        extendsFrom annotationProcessor\n    <span class=\"token punctuation\">}</span>\n    querydsl<span class=\"token punctuation\">.</span>extendsFrom compileClasspath\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 설정하고, intellij 우측의 gradle 탭의 [other] 디렉토리 하위의 compileQuerydsl을 더블 클릭 해보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB50lEQVQoz22QyY7TQBQA/TWTeIt3x0532+3YcbxHmYlG4oLghhAnLnx+IXtgBIhDqfrwVK33DD2MVN2VZuxphp7rPDO8PGiXG5euo2sv6K6n7EeKcWB4fqZbbojrgGxH5GVEthPFdabuF4yyqZG6QFUKWUqkVqiqRGiFLCSqEGRKkKiSRCpiWSKrkm6+oy898nxFtwNCN6iqwfD9kGAlDHBsh93Tjv3uN3t2u/1mc7fD3K/vJ1zHpp0npmVCqhNC5huFLjCiNCIXMWka4h18DgeXg+/iHhxs2/4HB9sycUKBfHyn+fCDZPpG2H0h6L+S958wwjQhO+bEfsDB9fCDANd1sW3rP0EbyzI5+BGnemF+/czw8pH8PJPqibK9YYTHlDg9EgbRFvP8AMuyMC1z85+sQdM08XwfVVUs9zv9OKDrM0IplK4wUpGSZzlpmm3R9Z7r6oEX4nkejvu2uuM4G5ZtESUxxblheX5wf7zSTQtSnzkVGiOMQ1x3HXb/wt38FnHW4K/oeoowjqiHmdvjlabr32NbMMlO5EKSHDOiKCaKk3fCOCGIYoLNyS/HxGlGPUwMtzu6aRFlharqDSM+ZlswLUp8VRCoglBIAiE5SkVVN8hSU+hqQ5UaWZTkJ7F9GCXpO2l+4ieUpkz1SmF5NgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image1\"\n        title=\"image1\"\n        src=\"/static/6b4e84dc9ddca36858caaaf9c3c199f6/37523/image1.png\"\n        srcset=\"/static/6b4e84dc9ddca36858caaaf9c3c199f6/e9ff0/image1.png 180w,\n/static/6b4e84dc9ddca36858caaaf9c3c199f6/f21e7/image1.png 360w,\n/static/6b4e84dc9ddca36858caaaf9c3c199f6/37523/image1.png 720w,\n/static/6b4e84dc9ddca36858caaaf9c3c199f6/302a4/image1.png 1080w,\n/static/6b4e84dc9ddca36858caaaf9c3c199f6/07a9c/image1.png 1440w,\n/static/6b4e84dc9ddca36858caaaf9c3c199f6/c2d13/image1.png 2560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>그러면 $buildDir/generated/querydsl 디렉토리 하위에 Q로 시작하는 클래스 파일들이 생성되는 것을 확인할 수 있다.\n앞으로 빌드할 때도 compileQuerydsl의 작업까지 포함해서 수행해주게 될 것이다. 끝~!</p>","excerpt":"1. QueryDSL이란? QueryDSL은 Java 코드로 쿼리를 짜서 DB에 접근하는 방식이다. 기존 데이터 접근 방식인 jdbcTemplate, Mybatis 와 같은 방법에서는 직접 SQL 쿼리를 짜야만 했다. JPA에서는 Spring data jpa를 통해서 조회 조건이 간단한 쿼리 같은 경우에는 별도의 쿼리를 짜지 않고도 DB로부터 데이터를 불러 올 수 있었다. 그러나 복잡한 조회가 필요할 경우 불가피하게 JPQL을 통해서 아래와 같이 쿼리를 직접 짜야 했다. 그러나 QueryDSL을 사용하면 아래와 같이 자바코드의 형태로 쿼리를 짤 수 있고 여러가지 장점이 있다. 컴파일 타임에서 에러를 잡을 수 있다. 코드 자동 완성의 도움을 받을 수 있다. 동적쿼리를 편하게 짤 수 있도록 도움을 준다. 메소드를 뽑아 낼 수 있어 재사용이 가능하다. Spring data JPA와 QueryDSL을 함께 활용하면 RDB를 사용한 개발환경에서\n개발자는 자바를 통해 쿼리를 자유롭게 짤 수 …","frontmatter":{"date":"June 06, 2022","title":"[QueryDSL] 1. QueryDSL이란? QueryDSL 환경설정 ","categories":"Spring","author":"jjunyong","emoji":"🧢"},"fields":{"slug":"/querydsl1/"}},"next":{"id":"d4e6a6e4-e0b4-52de-85b7-736628dbf089","html":"<p>Spring boot 개발환경에서 AWS S3를 활용하여 파일을 업로드하고 이를 DB를 URL로 저장하는 방법과\n파일 명을 이용해서 S3로부터 파일을 다운로드 하는 방법에 대해서 알아보자.</p>\n<h3 id=\"1-spring-boot-의존성-환경-설정\" style=\"position:relative;\"><a href=\"#1-spring-boot-%EC%9D%98%EC%A1%B4%EC%84%B1-%ED%99%98%EA%B2%BD-%EC%84%A4%EC%A0%95\" aria-label=\"1 spring boot 의존성 환경 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Spring boot 의존성, 환경 설정</h3>\n<ul>\n<li>\n<p>build.gradle</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">implementation 'io.awspring.cloud:spring-cloud-starter-aws:2.3.1'</code></pre></div>\n</li>\n<li>\n<p>app.properties</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#AWS 접근 키\ncloud.aws.credentials.accessKey=accesskey값\ncloud.aws.credentials.secretKey=secretkey값\n# AWS S3 버킷정보\ncloud.aws.s3.bucket=onyou-bucket\ncloud.aws.region.static=ap-northeast-2\ncloud.aws.stack.auto=false\n# 파일 업로드 크기 설정\nspring.servlet.multipart.max-file-size=20MB\nspring.servlet.multipart.max-request-size=20MB\n</code></pre></div>\n</li>\n</ul>\n<h3 id=\"2-s3-config-클래스-설정\" style=\"position:relative;\"><a href=\"#2-s3-config-%ED%81%B4%EB%9E%98%EC%8A%A4-%EC%84%A4%EC%A0%95\" aria-label=\"2 s3 config 클래스 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. S3 Config 클래스 설정</h3>\n<p>위 application.properties에서 설정한 accessKey, secretkey, region값을 @Value 어노테이션을 활용하여\nAwsS3Config 클래스에서 가져와서 AWSCredential을 설정한다.</p>\n<p>이 때 나는 jasypt를 활용해서 key값을 보호하도록 했는데 해당 내용은 <a href=\"https://jjunyong.github.io/aws_jasypt/\">이 글</a>을 참고하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AwsS3Config</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${cloud.aws.credentials.accesskey}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> accessKey<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${cloud.aws.credentials.secretkey}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> secretKey<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${cloud.aws.region.static}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> region<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AmazonS3Client</span> <span class=\"token function\">amazonS3Client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">BasicAWSCredentials</span> awsCreds <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BasicAWSCredentials</span><span class=\"token punctuation\">(</span>decryptAccessKey<span class=\"token punctuation\">,</span>decryptSecretKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AmazonS3Client</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">AmazonS3ClientBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">standard</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">withRegion</span><span class=\"token punctuation\">(</span>region<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">withCredentials</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AWSStaticCredentialsProvider</span><span class=\"token punctuation\">(</span>awsCreds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"3-s3-업로드-controller-설정\" style=\"position:relative;\"><a href=\"#3-s3-%EC%97%85%EB%A1%9C%EB%93%9C-controller-%EC%84%A4%EC%A0%95\" aria-label=\"3 s3 업로드 controller 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. S3 업로드 Controller 설정</h3>\n<p>나는 본 글의 title처럼 Club이라는 entity를 생성할 때 S3에 썸네일 이미지가 업로드 됨과 동시에 DB에 S3에 업로드된 이미지의 URL도\n저장되도록 설정하도록 하였다.</p>\n<p>그리고 그러기 위해서 @RequestPart 어노테이션을 활용하여</p>\n<p>controller 단에서 createClub이라는 API를 호출 시에 file과 함께 clubCreateRequest DTO를 함께 전달 받도록 하였다.</p>\n<p>이 때 클라이언트에서 요청 시에 clubCreateRequest의 content-type을 반드시 application/json으로 지정해준 form data로 전송해야 함에 유의하자.</p>\n<p>controller의 구조는 다음과 같다.</p>\n<ul>\n<li>form-data로 DTO와 File값을 함께 받아온다.</li>\n<li>받아온 파일이 존재하는 지 확인</li>\n<li>awsS3servce.uploadFile에 파일을 넘겨서 업로드를 수행한 후 업로드 한 url을 리턴받음</li>\n<li>리턴받은 url을 thumbnailUrl이라는 DTO의 필드에 저장한후 DTO를 createClub에 전달하여 Club 생성할 때 url도 함께 반영되도록 함</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/clubs\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClubController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ClubService</span> clubService<span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">AwsS3Service</span> awsS3Service<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Header</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">createClub</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestPart</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"file\"</span><span class=\"token punctuation\">,</span> required <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">MultipartFile</span> thumbnail<span class=\"token punctuation\">,</span>\n                                     <span class=\"token annotation punctuation\">@Valid</span> <span class=\"token annotation punctuation\">@RequestPart</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"clubCreateRequest\"</span><span class=\"token punctuation\">)</span>\n                                             <span class=\"token class-name\">ClubCreateRequest</span> clubCreateRequest<span class=\"token punctuation\">,</span>\n                                     <span class=\"token class-name\">HttpServletRequest</span> httpServletRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>thumbnail<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span>FILE_EMPTY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n\n        <span class=\"token class-name\">String</span> thumbnailUrl <span class=\"token operator\">=</span> awsS3Service<span class=\"token punctuation\">.</span><span class=\"token function\">uploadFile</span><span class=\"token punctuation\">(</span>thumbnail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//s3에 저장하고 저장한 image url 리턴</span>\n        clubCreateRequest<span class=\"token punctuation\">.</span><span class=\"token function\">setThumbnailUrl</span><span class=\"token punctuation\">(</span>thumbnailUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Club</span> club <span class=\"token operator\">=</span> clubService<span class=\"token punctuation\">.</span><span class=\"token function\">createClub</span><span class=\"token punctuation\">(</span>clubCreateRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Header</span><span class=\"token punctuation\">.</span><span class=\"token function\">OK</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"club_id: \"</span><span class=\"token operator\">+</span> club<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"4-s3-service-설정\" style=\"position:relative;\"><a href=\"#4-s3-service-%EC%84%A4%EC%A0%95\" aria-label=\"4 s3 service 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. S3 Service 설정</h3>\n<p>S3 service 에서는 controller에서 전달받은 image를 업로드해주고 반환값으로 업로드한 url을 리턴하는 과정을 수행한다.</p>\n<p>프로세스는 다음과 같다.</p>\n<ul>\n<li>\n<p>s3에 업로드할 파일명 생성</p>\n<ul>\n<li>original파일명(업로드된 파일명)으로 확장자 존재여부 체크 ( getFileExtension 메소드 )</li>\n<li>key 값으로 original파일명으로 파일명 랜덤값 생성 ( createFileName 메소드 ) 후 뒤에 ‘_original파일명’ 붙여줌</li>\n</ul>\n</li>\n<li>\n<p>S3에 파일업로드</p>\n<ul>\n<li>bucket, key, objectMetadata 으로 pubObject 메소드 통해서 s3에 업로드 수행</li>\n</ul>\n</li>\n<li>\n<p>return값으로 url 리턴</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AwsS3Service</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${cloud.aws.s3.bucket}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> bucket<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AmazonS3</span> amazonS3<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">uploadFile</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MultipartFile</span> file<span class=\"token punctuation\">,</span>  <span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">String</span> fileName <span class=\"token operator\">=</span> <span class=\"token function\">createFileName</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">getOriginalFilename</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ObjectMetadata</span> objectMetadata <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        objectMetadata<span class=\"token punctuation\">.</span><span class=\"token function\">setContentLength</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        objectMetadata<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">getContentType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">String</span> key <span class=\"token operator\">=</span> fileName<span class=\"token operator\">+</span><span class=\"token string\">\"_\"</span><span class=\"token operator\">+</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">getOriginalFilename</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InputStream</span> inputStream <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            amazonS3<span class=\"token punctuation\">.</span><span class=\"token function\">putObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PutObjectRequest</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> inputStream<span class=\"token punctuation\">,</span> objectMetadata<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">withCannedAcl</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CannedAccessControlList<span class=\"token punctuation\">.</span>PublicRead</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResponseStatusException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span>INTERNAL_SERVER_ERROR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"파일 업로드에 실패했습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> amazonS3<span class=\"token punctuation\">.</span><span class=\"token function\">getUrl</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">createFileName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> fileName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 파일명 random값 생성</span>\n        <span class=\"token keyword\">return</span> UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token function\">getFileExtension</span><span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getFileExtension</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> fileName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//  파일 명에 '.' 의 존재 여부 체크 </span>\n    \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> fileName<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">.</span><span class=\"token function\">lastIndexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">StringIndexOutOfBoundsException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResponseStatusException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span>BAD_REQUEST<span class=\"token punctuation\">,</span> <span class=\"token string\">\"잘못된 형식의 파일(\"</span> <span class=\"token operator\">+</span> fileName <span class=\"token operator\">+</span> <span class=\"token string\">\") 입니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<br>\n여기까지 S3 파일 업로드를 위한 모든 환경설정이 끝났다. \n<p>이렇게 해주고 나서 postman을 활용해서 아래와 같은 형태로 설정하고 테스트 하면 정상적으로 파일 업로드가 되고,\nDB에 URL이 저장됨을 확인 할 수 있다. 물론 당연히, clubService.createClub메소드에서 DTO를 통해 DB에 데이터를 저장하는 로직과\nDB에 해당하는 테이블과 컬럼이 존재해야 한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAArklEQVQY032OCwrDIBBEPXkP1p6kF0hIaKL4XWPilBEsQksXBlln5+0qay2899DGYNc7tu0F7x1CCB/FGCEiyDm3d1SSDBTB4ym43SNUzoIYPGJKLUiY97aBUkotxLquC6UUjHWe5/BXUbJALcvSLqTBUK1ASgJjDI7jaKJHuHOuQThH9Yv7Mh6ktNYNSIOfDNCYpgnrumKeZ3ApgVSfofqy3hOs8KNqrV/6Nzf2b9wmhjShy/DCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image1\"\n        title=\"image1\"\n        src=\"/static/2b39dec56a46a29e4a9b3702a9b8b81c/37523/image1.png\"\n        srcset=\"/static/2b39dec56a46a29e4a9b3702a9b8b81c/e9ff0/image1.png 180w,\n/static/2b39dec56a46a29e4a9b3702a9b8b81c/f21e7/image1.png 360w,\n/static/2b39dec56a46a29e4a9b3702a9b8b81c/37523/image1.png 720w,\n/static/2b39dec56a46a29e4a9b3702a9b8b81c/302a4/image1.png 1080w,\n/static/2b39dec56a46a29e4a9b3702a9b8b81c/07a9c/image1.png 1440w,\n/static/2b39dec56a46a29e4a9b3702a9b8b81c/5c4aa/image1.png 2492w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<hr>","frontmatter":{"date":"April 23, 2022","title":"[AWS] Spring boot에서 AWS S3로 파일 업로드하면서 DB에 URL 저장하는 방법","categories":"AWS","author":"jjunyong","emoji":"🧢"},"fields":{"slug":"/aws-s3/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://jjunyong.github.io","comments":{"utterances":{"repo":"jjunyong/jjunyong.github.io"}}}}},"pageContext":{"slug":"/querydsl1/","nextSlug":"/aws-s3/","prevSlug":""}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}