{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/on-premise2/",
    "result": {"data":{"cur":{"id":"83fbc418-ebe7-5158-a8e0-5f8d2d000eb0","html":"<h2 id=\"1-사전-설정\" style=\"position:relative;\"><a href=\"#1-%EC%82%AC%EC%A0%84-%EC%84%A4%EC%A0%95\" aria-label=\"1 사전 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 사전 설정</h2>\n<p>: 사전 설정은 모든 노드에서 실행해주어야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -fsSL <span class=\"token punctuation\">[</span>https://get.docker.com<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://get.docker.com/<span class=\"token punctuation\">)</span> -o <span class=\"token punctuation\">[</span>get-docker.sh<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>http://get-docker.sh/<span class=\"token punctuation\">)</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">sh</span> <span class=\"token punctuation\">[</span>get-docker.sh<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>http://get-docker.sh/<span class=\"token punctuation\">)</span>\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> --now docker <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> systemctl status docker --no-pager\n<span class=\"token function\">sudo</span> <span class=\"token function\">usermod</span> -aG docker onyouadmin\n<span class=\"token function\">sudo</span> docker container <span class=\"token function\">ls</span></code></pre></div>\n<h3 id=\"cri-docker-install\" style=\"position:relative;\"><a href=\"#cri-docker-install\" aria-label=\"cri docker install permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cri-docker Install</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">VER</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> -s <span class=\"token punctuation\">[</span>https://api.github.com/repos/Mirantis/cri-dockerd/releases/latest<span class=\"token operator\">|</span>grep<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://api.github.com/repos/Mirantis/cri-dockerd/releases/latest%7Cgrep<span class=\"token punctuation\">)</span> tag_name <span class=\"token operator\">|</span> <span class=\"token function\">cut</span> -d <span class=\"token string\">'\"'</span> -f <span class=\"token number\">4</span><span class=\"token operator\">|</span><span class=\"token function\">sed</span> <span class=\"token string\">'s/v//g'</span><span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$VER</span>\n<span class=\"token function\">wget</span> <span class=\"token punctuation\">[</span>https://github.com/Mirantis/cri-dockerd/releases/download/v<span class=\"token variable\">${VER}</span>/cri-dockerd-<span class=\"token variable\">${VER}</span>.amd64.tgz<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://github.com/Mirantis/cri-dockerd/releases/download/v$%7BVER%7D/cri-dockerd-$%7BVER%7D.amd64.tgz<span class=\"token punctuation\">)</span>\n<span class=\"token function\">tar</span> xvf cri-dockerd-<span class=\"token variable\">${VER}</span>.amd64.tgz\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> cri-dockerd/cri-dockerd /usr/local/bin/</code></pre></div>\n<h3 id=\"cri-docker-version-check\" style=\"position:relative;\"><a href=\"#cri-docker-version-check\" aria-label=\"cri docker version check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cri-docker Version Check</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cri-dockerd --version\n\n<span class=\"token function\">wget</span> https://raw.githubusercontent.com/Mirantis/cri-dockerd/master/packaging/systemd/cri-docker.service\n<span class=\"token function\">wget</span> https://raw.githubusercontent.com/Mirantis/cri-dockerd/master/packaging/systemd/cri-docker.socket\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> cri-docker.socket cri-docker.service /etc/systemd/system/\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> -i -e <span class=\"token string\">'s,/usr/bin/cri-dockerd,/usr/local/bin/cri-dockerd,'</span> /etc/systemd/system/cri-docker.service\n\n<span class=\"token function\">sudo</span> systemctl daemon-reload\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> cri-docker.service\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> --now cri-docker.socket</code></pre></div>\n<h3 id=\"cri-docker-active-check\" style=\"position:relative;\"><a href=\"#cri-docker-active-check\" aria-label=\"cri docker active check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cri-docker Active Check</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl restart docker <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> systemctl restart cri-docker\n<span class=\"token function\">sudo</span> systemctl status cri-docker.socket --no-pager</code></pre></div>\n<h3 id=\"docker-cgroup-change-require-to-systemd\" style=\"position:relative;\"><a href=\"#docker-cgroup-change-require-to-systemd\" aria-label=\"docker cgroup change require to systemd permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker cgroup Change Require to Systemd</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> /etc/docker\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/docker/daemon.json</span>\n{\n\"exec-opts\": [\"native.cgroupdriver=systemd\"],\n\"log-driver\": \"json-file\",\n\"log-opts\": {\n\"max-size\": \"100m\"\n},\n\"storage-driver\": \"overlay2\"\n}\nEOF</span>\n``<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">bash</span>\n\n<span class=\"token variable\">`</span></span>``bash\n<span class=\"token function\">sudo</span> systemctl restart docker <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> systemctl restart cri-docker\n<span class=\"token function\">sudo</span> docker info <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> Cgroup</code></pre></div>\n<h2 id=\"2--패키지-설치--kubeadm-kubectl-kubelet\" style=\"position:relative;\"><a href=\"#2--%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98--kubeadm-kubectl-kubelet\" aria-label=\"2  패키지 설치  kubeadm kubectl kubelet permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.  패키지 설치 : kubeadm, kubectl, kubelet</h2>\n<p>패키지 설치도 모든 노드에서 실행 해준다.</p>\n<ol>\n<li>\n<p>Swap disable 처리</p>\n<p><code class=\"language-text\">swapoff -a &amp;&amp; sed -i '/swap/s/^/#/' /etc/fstab</code></p>\n</li>\n<li>\n<p>iptable이 bridged traffic 을 바라볼 수 있도록 설정.</p>\n<p><code class=\"language-text\">cat &lt;&lt;EOF > /etc/sysctl.d/k8s.conf</code></p>\n<p><code class=\"language-text\">net.bridge.bridge-nf-call-ip6tables = 1\n net.bridge.bridge-nf-call-iptables = 1\n EOF</code></p>\n<ul>\n<li>컨테이너는 가상화된 네트워크 인터페이스를 사용하므로, 컨테이너 간의 통신 및 네트워크 기능을 지원하기 위해 호스트 단에서 커널 parameter를 위와 같이 변경하는 것이다.\n<ol>\n<li>net.bridge.bridge-nf-call-ip6tables = 1: 이 설정은 IPv6 네트워크 트래픽이 브리지로 전달되어 IP 테이블에서 필터링될 수 있도록 한다.</li>\n<li>net.bridge.bridge-nf-call-iptables = 1: 이 설정은 IPv4 네트워크 트래픽이 브리지로 전달되어 IP 테이블에서 필터링될 수 있도록 한다.</li>\n</ol>\n</li>\n</ul>\n</li>\n<li>\n<p>방화벽 해제</p>\n<p><code class=\"language-text\">systemctl stop firewalld</code></p>\n<p><code class=\"language-text\">systemctl disable firewalld</code></p>\n</li>\n<li>\n<p>SELinux를 permissive mode로 설정</p>\n<p><code class=\"language-text\">setenforce 0</code></p>\n<p><code class=\"language-text\">sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config</code></p>\n</li>\n<li>\n<p>kubeadm, kubelet, kubectl 설치</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /etc/yum.repos.d/kubernetes.repo</span>\n\n[kubernetes]\nname=Kubernetes\nbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg\nexclude=kubelet kubeadm kubectl\nEOF</span>\n\nyum <span class=\"token function\">install</span> -y kubelet kubeadm kubectl --disableexcludes<span class=\"token operator\">=</span>kubernetes\n\nsystemctl start kubelet <span class=\"token operator\">&amp;&amp;</span> systemctl <span class=\"token builtin class-name\">enable</span> kubelet</code></pre></div>\n</li>\n</ol>\n<h2 id=\"3-마스터-노드-설정\" style=\"position:relative;\"><a href=\"#3-%EB%A7%88%EC%8A%A4%ED%84%B0-%EB%85%B8%EB%93%9C-%EC%84%A4%EC%A0%95\" aria-label=\"3 마스터 노드 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 마스터 노드 설정</h2>\n<h3 id=\"controller-node\" style=\"position:relative;\"><a href=\"#controller-node\" aria-label=\"controller node permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Controller Node</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> kubeadm config images pull --cri-socket unix:///run/cri-dockerd.sock\n\n<span class=\"token function\">sudo</span> kubeadm init --ignore-preflight-errors<span class=\"token operator\">=</span>all --pod-network-cidr<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.0.0/16 --apiserver-advertise-address<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>마스터노드 IP<span class=\"token punctuation\">}</span> --cri-socket /var/run/cri-dockerd.sock</code></pre></div>\n<h3 id=\"설치-시-출력되는-join-command-를-복사해둔다\" style=\"position:relative;\"><a href=\"#%EC%84%A4%EC%B9%98-%EC%8B%9C-%EC%B6%9C%EB%A0%A5%EB%90%98%EB%8A%94-join-command-%EB%A5%BC-%EB%B3%B5%EC%82%AC%ED%95%B4%EB%91%94%EB%8B%A4\" aria-label=\"설치 시 출력되는 join command 를 복사해둔다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>설치 시 출력되는 join Command 를 복사해둔다.</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubeadm <span class=\"token function\">join</span> <span class=\"token punctuation\">{</span>마스터노드IP<span class=\"token punctuation\">}</span>:6443 --token r8gfco.6s7f60dns4vgwcc0 <span class=\"token punctuation\">\\</span>\n--discovery-token-ca-cert-hash sha256:7b0f82be076748e67f8615eab0b86a61317bac397f94b2921810231ab14afdcc</code></pre></div>\n<h3 id=\"kubeadm-을-root-처럼-사용하기-위한-추가-설정\" style=\"position:relative;\"><a href=\"#kubeadm-%EC%9D%84-root-%EC%B2%98%EB%9F%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0-%EC%9C%84%ED%95%9C-%EC%B6%94%EA%B0%80-%EC%84%A4%EC%A0%95\" aria-label=\"kubeadm 을 root 처럼 사용하기 위한 추가 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>kubeadm 을 root 처럼 사용하기 위한 추가 설정</h3>\n<div class=\"gatsby-highlight\" data-language=\"basn\"><pre class=\"language-basn\"><code class=\"language-basn\">mkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config</code></pre></div>\n<h3 id=\"서비스-확인--ready--running-\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%99%95%EC%9D%B8--ready--running-\" aria-label=\"서비스 확인  ready  running  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서비스 확인 ( Ready , Running )</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get nodes -o wide\nkubectl get pod -A</code></pre></div>\n<h2 id=\"4-워커-노드-설정\" style=\"position:relative;\"><a href=\"#4-%EC%9B%8C%EC%BB%A4-%EB%85%B8%EB%93%9C-%EC%84%A4%EC%A0%95\" aria-label=\"4 워커 노드 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 워커 노드 설정</h2>\n<h3 id=\"클러스터-join\" style=\"position:relative;\"><a href=\"#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-join\" aria-label=\"클러스터 join permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>클러스터 join</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubeadm <span class=\"token function\">join</span> <span class=\"token number\">172.17</span>.255.172:6443 --token te423w.tkhwpeau43rwafdg <span class=\"token punctuation\">\\</span>\n--discovery-token-ca-cert-hash sha256:6ec04d16b4695af8407ca7d0ac8dc0b88655b431156e2189da118d8a74e07778 --cri-socket /var/run/cri-dockerd.sock</code></pre></div>\n<h3 id=\"check\" style=\"position:relative;\"><a href=\"#check\" aria-label=\"check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Check</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">systemctl status kubelet</code></pre></div>\n<h3 id=\"worker-계정에-kubectl-사용-환경변수-추가\" style=\"position:relative;\"><a href=\"#worker-%EA%B3%84%EC%A0%95%EC%97%90-kubectl-%EC%82%AC%EC%9A%A9-%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98-%EC%B6%94%EA%B0%80\" aria-label=\"worker 계정에 kubectl 사용 환경변수 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>worker 계정에 kubectl 사용 환경변수 추가</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> ~\n<span class=\"token function\">mkdir</span> -p <span class=\"token environment constant\">$HOME</span>/.kube\n<span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> -i  /etc/kubernetes/admin.conf <span class=\"token environment constant\">$HOME</span>/.kube/config\n<span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> -u<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">:</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> -g<span class=\"token variable\">)</span></span> <span class=\"token environment constant\">$HOME</span>/.kube/config</code></pre></div>\n<p>여기까지 하면 기본적으로 master 노드와 worker 노드 셋팅이 완료된 것이지만, 서로 다른 노드들이 pod간 통신하기 위해 CNI를 설치 해주어야한다.\nCNI 설치를 완료하면 coredns가 pending -> running상태로 변경되게 될 것이다.</p>\n<h2 id=\"5-cni-설치\" style=\"position:relative;\"><a href=\"#5-cni-%EC%84%A4%EC%B9%98\" aria-label=\"5 cni 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. CNI 설치</h2>\n<ul>\n<li>Calico 설치\n: <a href=\"https://docs.tigera.io/calico/latest/getting-started/kubernetes/self-managed-onprem/onpremises\">https://docs.tigera.io/calico/latest/getting-started/kubernetes/self-managed-onprem/onpremises</a>\n<ul>\n<li>manifest 방법으로 설치해주면 되며, 192.168 대역이 아닌 다른 대역을 pod의 대역으로 사용했다면 가이드에 따라서 수정 필요한 부분 적용해주면 된다.</li>\n</ul>\n</li>\n</ul>","excerpt":"1. 사전 설정 : 사전 설정은 모든 노드에서 실행해주어야 한다. cri-docker Install cri-docker Version Check cri-docker Active Check Docker cgroup Change Require to Systemd 2.  패키지 설치 : kubeadm, kubectl, kubelet 패키지 설치도 모든 노드에서 실행 해준다. Swap disable 처리  iptable이 bridged traffic 을 바라볼 수 있도록 설정.   컨테이너는 가상화된 네트워크 인터페이스를 사용하므로, 컨테이너 간의 통신 및 네트워크 기능을 지원하기 위해 호스트 단에서 커널 parameter를 위와 같이 변경하는 것이다. net.bridge.bridge-nf-call-ip6tables = 1: 이 설정은 IPv6 네트워크 트래픽이 브리지로 전달되어 IP 테이블에서 필터링될 수 있도록 한다. net.bridge.bridge-nf-call-iptables = …","frontmatter":{"date":"July 01, 2023","title":"On-premise 서버 구축하기 2. K8S 클러스터 설치","categories":"DevOps","author":"jjunyong","emoji":"🧢"},"fields":{"slug":"/on-premise2/"}},"next":{"id":"db355e4e-68b0-52ba-bab3-1048577684ab","html":"<h1 id=\"1-서버vm-구축\" style=\"position:relative;\"><a href=\"#1-%EC%84%9C%EB%B2%84vm-%EA%B5%AC%EC%B6%95\" aria-label=\"1 서버vm 구축 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 서버/VM 구축</h1>\n<h2 id=\"1-서버-셋팅\" style=\"position:relative;\"><a href=\"#1-%EC%84%9C%EB%B2%84-%EC%85%8B%ED%8C%85\" aria-label=\"1 서버 셋팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 서버 셋팅</h2>\n<h3 id=\"1-공유기-설정\" style=\"position:relative;\"><a href=\"#1-%EA%B3%B5%EC%9C%A0%EA%B8%B0-%EC%84%A4%EC%A0%95\" aria-label=\"1 공유기 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1) 공유기 설정</h3>\n<ul>\n<li>공유기 어드민 콘솔에 접근하여 DDNS 설정, 포트포워딩, 고정IP 할당을 해준다. 공유기 콘솔에 접근 하는 방법은 공유기 제조사 마다 다른데, 나의 경우는 tplink라서 192.168.0.1로 접근 가능</li>\n<li>고정 IP 설정\n<ul>\n<li>공유기 콘솔에 들어가면 연결된 서버에 고정 ip를 할당</li>\n</ul>\n</li>\n<li>포트포워딩 설정\n<ul>\n<li>할당된 고정 ip에 포트포워딩을 설정한다. 예를 들어 공유기로 8080 포트로 들어왔을 때 서버의 9090포트로 포워딩 되도록 설정하는 것이다.</li>\n</ul>\n</li>\n<li>동적 DNS 설정 ( DDNS )\n<ul>\n<li>실제 공유기의 공인 ip는 변동되기 때문에 동적 DNS 설정을 통해 ‘aaa.tplinkdns.com’ 이런 도메인으로 외부에서 서버로 접속 할 수 있도록 해주어야 한다.</li>\n</ul>\n</li>\n<li>여기까지 하면 aaa.tplinikdns.com:8080으로 접속했을 때, 내 서버가 설치된 공유기의 8080포트로 접속이 되게 되고, 고정ip와 포트포워딩 설정을 통해 LAN내에 존재하는 내 서버의 9090포트로 접속되게 되는 것이다.</li>\n</ul>\n<h2 id=\"2-hyper-v로-vm-설치\" style=\"position:relative;\"><a href=\"#2-hyper-v%EB%A1%9C-vm-%EC%84%A4%EC%B9%98\" aria-label=\"2 hyper v로 vm 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Hyper-V로 VM 설치</h2>\n<p><a href=\"https://keyhyuk-kim.medium.com/hyper-v-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C-%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-master-worker-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%B6%95%ED%95%98%EA%B8%B0-b7aead20132f\">https://keyhyuk-kim.medium.com/hyper-v-환경에서-쿠버네티스-master-worker-클러스터-구축하기-b7aead20132f</a></p>\n<h3 id=\"가상-스위치-설정하기\" style=\"position:relative;\"><a href=\"#%EA%B0%80%EC%83%81-%EC%8A%A4%EC%9C%84%EC%B9%98-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0\" aria-label=\"가상 스위치 설정하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>가상 스위치 설정하기</h3>\n<p>default switch는 호스트 서버가 재부팅될 때 마다 ip가 변경되므로, Hyper-V에서 새로운 가상 스위치를 생성하여 VM들이 해당 스위치를 선택하도록 해주어야 한다. 또한 호스트 서버의 네트웍 설정에서 가상 스위치의 ip와 subnet mask를 설정해주어야 한다.</p>\n<ul>\n<li>\n<p>Hyper-V 가상 스위치 설정</p>\n<ul>\n<li>내부 네트워크로 선택</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 95%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAACNklEQVQ4y42UyY7TQBCG/b5zQIK3QRy4IMQBpBGcOYDmwAWksUZJxo4z3tpuO17aS+whdn5UNbGVRImJpU+u3v7qqq5uzZEpgjBGGK2xTsiWSNIcTduiaRrUdc2QfQka32w2SNMUmlwnWPoBokCgVimwbQFs0VQlDGuF1WoF27bh+z48z7uIoHHfh/Z9JvHhl4v3Pyx8/JPhs17g032Jn2aOB/0eIghQliXyPJ9EqQJShtDe3fm4+eLi9a3Aq68R3nwLcXMr8fYuQBKFKMtqDPsSFG5VVQiEgJblBTyZwhcS6P4C6AD0eG5q9tx1Hfq+5/92u71I27bwXRcaKfd9x8ndNC2a9pmp6g1Mw8B8PsdsNoNlWWMuKflZlh1BzkMKmQTPfeQgDEMW03UdpmliuVyysOM4R5AjPhhxILjb7UYGQSEECxiGwYsGXNdlAfoHQcCOoyji+UeCh38StB0bpmng0TCQK4WyKFAUBZRSR9AY9QdSXhakJD/ta9Db1yDl71wOuU059NzpHdLiITzPc9kmqJ/CG8ONYxYle1JQSokkScZdDFDfwNher6dDJsE4jjlH50qEIJvGaacry4L7v0MhwWHhFDSHDiU83eFp2VwjOIy/FHZ0veA1wnEcTd+U0x2qPEdVFigLxTaF+fLSKH6RaL5GRrt/TAeoTY6GpBOFUgjjDIuVB8uLIKOYy4lEhvLim0K1Q6d0CvUfQm/d0hH4/WBCf7TxZDv8eFDh0z1fLBZ8Rf8BwZ+c/vC8/KQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image1.png\"\n        title=\"image1.png\"\n        src=\"/static/2d4f7180998ab040fc5e9ad289f70a39/37523/image1.png\"\n        srcset=\"/static/2d4f7180998ab040fc5e9ad289f70a39/e9ff0/image1.png 180w,\n/static/2d4f7180998ab040fc5e9ad289f70a39/f21e7/image1.png 360w,\n/static/2d4f7180998ab040fc5e9ad289f70a39/37523/image1.png 720w,\n/static/2d4f7180998ab040fc5e9ad289f70a39/302a4/image1.png 1080w,\n/static/2d4f7180998ab040fc5e9ad289f70a39/07a9c/image1.png 1440w,\n/static/2d4f7180998ab040fc5e9ad289f70a39/cb425/image1.png 1678w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n</li>\n<li>\n<p>이더넷 속성 - 공유 에서 아래와 같이 설정하여 LAN과 ip대역을 고융하도록 설정한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABa0lEQVQoz41S7W6DMAzM+z/Zfm2rVKnSJFa0gkggkECSElrgJrsDdVM/Zskywrnz+RIRh4g+RnSuw/F4RNu28N5zds6BYpomADOuYxxHnE4nxvR9j3ma0HYdRKUbSFVCVRq6btAYy9XaFqrUUGUFF3p8ZhqyrKBrg7xQXGMcWIzzHi2dOSiILMuR5zmc8zyJJi5TQzhCKcX1ZbPH69s7ttstdrsd0jT9UQ5WR+GyDMJ7ByUlpJQsOXiPEAK6rkOMkS0g4DyNvOb5fMY4nvl7ni82LJWwgpSUZYkkSaC1XkFxGNgja+0KuBXUW/rOOQhSQ4SHw4FXJwJrDV8KES+E9/JaIWGY8OJX4B/DMDAReWeM4ZX/Am+pvBAGCLqAW7EMekZ4rZR8XwlvrULxbOVfHj4iXJIU/jeMtfRs/ONDxrCvdOOPsu8jCikhyPymaVDXNZq6Rq4qbD5SJF8F0nSPoijWp3QvqU+eS1ngGyKXpYRIVVfJAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image2.png\"\n        title=\"image2.png\"\n        src=\"/static/a5b70267b8169b16bbcc0d659d80f5c7/37523/image2.png\"\n        srcset=\"/static/a5b70267b8169b16bbcc0d659d80f5c7/e9ff0/image2.png 180w,\n/static/a5b70267b8169b16bbcc0d659d80f5c7/f21e7/image2.png 360w,\n/static/a5b70267b8169b16bbcc0d659d80f5c7/37523/image2.png 720w,\n/static/a5b70267b8169b16bbcc0d659d80f5c7/f4281/image2.png 1016w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n</li>\n</ul>\n<h3 id=\"vm-생성하기\" style=\"position:relative;\"><a href=\"#vm-%EC%83%9D%EC%84%B1%ED%95%98%EA%B8%B0\" aria-label=\"vm 생성하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VM 생성하기</h3>\n<p>Hyper-V에서 ‘새로 만들기’ 통해서 VM 생성하면 됨.\nVM 생성 시,</p>\n<ul>\n<li>2세대 VM으로 생성</li>\n<li>VM마다 정적으로 메모리를 지정해서 할당하였음.</li>\n<li>가상 스위치를 위에서 설정한 ‘내부’ 가상 스위치 설정</li>\n<li>controlplane은 VM, disk 모두 C드라이브에서 설치하였으며, worker 노드는 hard disk는 D드라이브에 .vhdx 할당함.</li>\n</ul>\n<h3 id=\"centos-79설치하기\" style=\"position:relative;\"><a href=\"#centos-79%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0\" aria-label=\"centos 79설치하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CentOS 7.9설치하기</h3>\n<p>하기 링크를 따라 설치하면 됨 신경 써야 할 부분은,</p>\n<ul>\n<li>Timezone 서울로 설정</li>\n<li>Disk 설정</li>\n<li>Network interface 설정</li>\n<li>VM에 OS 설치되는 동안 root 및 기타 admin계정 설정 가능.</li>\n</ul>\n<p><a href=\"https://da2uns2.tistory.com/entry/Hyper-V-Hyper-V%EC%97%90-CentOS-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0\">https://da2uns2.tistory.com/entry/Hyper-V-Hyper-V에-CentOS-설치하기</a></p>\n<h3 id=\"vm-고정-ip-설정\" style=\"position:relative;\"><a href=\"#vm-%EA%B3%A0%EC%A0%95-ip-%EC%84%A4%EC%A0%95\" aria-label=\"vm 고정 ip 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VM 고정 IP 설정</h3>\n<p>‘내부’ 가상 스위치의 ip 및 서브넷 마스크를 기준으로 하여 VM에 동적(DHCP)으로 ip가 할당되지만, 내가 원하는 것은 k8s 클러스터 구축이고\n이를 위해서는 각 노드의 ip는 고정되어 있어야 한다. k8s apiserver ip가 계속 바뀌면 안되니깐.\n따라서 CentOS 7.9 기준으로 아래와 같이 각 VM에서 ip를 설정해주었고, 외부와의 연결을 위해 DNS 설정도 해주어야 한다.</p>\n<ul>\n<li>sudo vi /etc/sysconfig/network-scripts/ifcfg-eth0 에서 아래와 같이 내용 추가 ( controlplane 기준 )</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    BOOTPROTO=static\n    IPADDR=192.168.X.Y\n    NETMASK=255.255.255.0\n    GATEWAY=192.168.X.1\n    DNS1=8.8.8.8\n    DNS2=8.8.4.4</code></pre></div>\n<ul>\n<li>위와 같이 설정 후 sudo systemctl restart network 명령을 실행하면 고정ip가 VM에 할당된다.</li>\n</ul>\n<p>이렇게 VM 설정, OS 설치 및 네트웍 설정이 끝나면 K8S 설치를 시작한다.</p>","frontmatter":{"date":"July 01, 2023","title":"On-premise 서버 구축하기 1. 공유기, 서버, 네트웍 설정","categories":"DevOps","author":"jjunyong","emoji":"🧢"},"fields":{"slug":"/on-premise1/"}},"prev":{"id":"ca567892-1197-5142-89b7-611bdfc77df1","html":"<h2 id=\"istio-환경구성\" style=\"position:relative;\"><a href=\"#istio-%ED%99%98%EA%B2%BD%EA%B5%AC%EC%84%B1\" aria-label=\"istio 환경구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Istio 환경구성</h2>\n<h3 id=\"istio-설치\" style=\"position:relative;\"><a href=\"#istio-%EC%84%A4%EC%B9%98\" aria-label=\"istio 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Istio 설치</h3>\n<p>생각보다 istio 설치하는 것 자체는 간단하다. 아래와 같은 과정을 따라 하면 끝이다.</p>\n<ul>\n<li>\n<p>Istioctl 다운로드 : controlplane에서 다운로드 한다.</p>\n<p><code class=\"language-text\">curl -L https://istio.io/downloadIstio | sh -</code></p>\n</li>\n<li>\n<p>istioctl 명령어 사용하기 위한 PATH 등록</p>\n<p><code class=\"language-text\">cd istio-1.17.2</code></p>\n<p><code class=\"language-text\">export PATH=$PWD/bin:$PATH</code></p>\n</li>\n<li>\n<p>istio 설치 ( <a href=\"https://istio.io/latest/docs/setup/install/istioctl/\">https://istio.io/latest/docs/setup/install/istioctl/</a> )</p>\n<p><code class=\"language-text\">istioctl install</code></p>\n<ul>\n<li>default Profile으로 설치됨</li>\n<li>설치 후 deployment에 istiod, istio-ingressgateway설치되었음을 확인 가능</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"istio-proxy-배포하기\" style=\"position:relative;\"><a href=\"#istio-proxy-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0\" aria-label=\"istio proxy 배포하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Istio proxy 배포하기</h3>\n<p>istio는 application pod에 sidecar로 istio-proxy 컨테이너를 배포함으써 istio-proxy 컨테이너가 pod에 대한 모든 트래픽을 중개하게 된다.\n이미 구성된 k8s 클러스터에서 istio-proxy 컨테이너를 inject하는 방법은 아래와 같다.</p>\n<h3 id=\"kube-inject\" style=\"position:relative;\"><a href=\"#kube-inject\" aria-label=\"kube inject permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>kube-inject</h3>\n<p><code class=\"language-text\">istioctl kube-inject -f deployment-nginx.yaml | kubectl apply -f -</code>\n→ 이렇게 하면 nginx deployment에 해당하는 pod에 istio-proxy가 삽입된다.</p>\n<h3 id=\"auto-injection\" style=\"position:relative;\"><a href=\"#auto-injection\" aria-label=\"auto injection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Auto Injection</h3>\n<ul>\n<li>\n<p><strong>namespace label을 통한 자동 주입 방법</strong></p>\n<p>일반적으로 더 간편한 방법은 해당하는 namespace의 전체 pod에 istio-proxy를 주입하는 방법이다.</p>\n<p><code class=\"language-text\">kubectl label namespace default istio-injection=enabled --</code>\n: default namespace의 모든 Pod에 사이드카 주입</p>\n<ul>\n<li>사이드카 제거 명령 : <code class=\"language-text\">kubectl label namespace default istio-injection-</code></li>\n</ul>\n</li>\n<li>\n<p>k logs -c 옵션 통해 istio-proxy의 로그만 따로 볼 수도 있다.</p>\n<p><code class=\"language-text\">k logs nginx-deployment-xxxyyzz -c istio-proxy</code></p>\n</li>\n<li>\n<p>enable된 namespace 라도 injection을 원치않는 pod는 pod의 label을 아래와 같이 설정하면 istio-proxy 주입이 되지 않도록 disable설정 가능하다.</p>\n<p><code class=\"language-text\">sidecar.istio.io/inject: “false”</code></p>\n</li>\n</ul>\n<h3 id=\"metallb-설치\" style=\"position:relative;\"><a href=\"#metallb-%EC%84%A4%EC%B9%98\" aria-label=\"metallb 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MetalLB 설치</h3>\n<p>아래 공식 설치 url에서 ‘installation by manifest’ 부분을 수행한다.\n<a href=\"https://metallb.universe.tf/installation/#installation-by-manifest\">https://metallb.universe.tf/installation/#installation-by-manifest</a></p>\n<ul>\n<li>\n<p>kubemode를 ipvs로, strictARP를 true로 설정한다</p>\n</li>\n<li>\n<p><code class=\"language-text\">kubectl edit configmap -n kube-system kube-proxy</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\napiVersion: [kubeproxy.config.k8s.io/v1alpha1](http://kubeproxy.config.k8s.io/v1alpha1)\nkind: KubeProxyConfiguration\nmode: \"ipvs\"\nipvs:\n  strictARP: true</code></pre></div>\n</li>\n<li>\n<p>설치</p>\n<ul>\n<li><code class=\"language-text\">kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.10/config/manifests/metallb-native.yaml</code></li>\n</ul>\n</li>\n</ul>\n<p>위와 같이 하면 설치는 다 되게 되는데, 이 상태에서는 LoadBalancer type의 서비스인 istio-ingressgateway service의 EXTERNAL-IP가 아직 Pending상태일 것이다.\nMetablLB를 통해 해당 서비스에 ip를 할당해주려면 아래 설정 page를 참고하여 Layer2 Configuration으로 ipaddresspool과 l2advertisement를 설정해주면 된다.\nipaddresspool에서는 호스트 서버와 통신 가능한 대역을 겹치지 않도록 설정해주도록 하자.</p>\n<ul>\n<li><a href=\"https://metallb.universe.tf/configuration/#layer-2-configuration\">https://metallb.universe.tf/configuration/#layer-2-configuration</a></li>\n</ul>","frontmatter":{"date":"July 02, 2023","title":"On-premise 서버 구축하기 4. Istio 환경 구축하기","categories":"DevOps","author":"jjunyong","emoji":"🧢"},"fields":{"slug":"/on-premise4/"}},"site":{"siteMetadata":{"siteUrl":"https://jjunyong.github.io","comments":{"utterances":{"repo":"jjunyong/jjunyong.github.io"}}}}},"pageContext":{"slug":"/on-premise2/","nextSlug":"/on-premise1/","prevSlug":"/on-premise4/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}